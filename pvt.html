<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychomotor Vigilance Task (PVT) & PANAS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100vh;
            background-color: #f4f4f9;
        }
        #task-screen, #end-screen, #panas-screen {
            display: none;
            user-select: none;
        }
        #task-screen {
            font-size: 2em;
        }
        #panas-screen {
            font-size: 1.2em;
            max-width: 800px;
            margin: 0 auto;
        }
        #preset-buttons button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
        }
        #start-btn, #start-panas-btn, #start-combined-btn {
            margin: 5px;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        #panas-header {
            font-size: 1em;
            margin-bottom: 20px;
        }
        #panas-word {
            font-size: 2.5em;
            margin: 20px 0;
        }
        #panas-word-en, #panas-word-ru {
            display: block;
        }
        .panas-options-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: nowrap;
            margin-top: 20px;
        }
        .panas-option-btn {
            margin: 0 10px;
            padding: 10px;
            font-size: 1em;
            cursor: pointer;
            background-color: #e0e0e0;
            border: none;
            border-radius: 5px;
            width: 150px;
            height: 80px;
            text-align: center;
            white-space: normal;
            line-height: 1.2;
        }
        .panas-option-btn:hover {
            background-color: #d0d0d0;
        }
        .panas-option-en, .panas-option-ru {
            display: block;
        }
    </style>
    <script type="text/javascript" src="auth.js"></script>
    <script type="text/javascript" src="telegram.js"></script>
</head>
<body>
    <div id="start-screen">
        <h1>Psychomotor Vigilance Task (PVT) & PANAS</h1>
        <label for="test-duration">Set Test Duration (seconds):</label>
        <input type="number" id="test-duration" value="60" min="10" max="600">
        <br>
        <label for="min-delay">Min Rest Duration (ms):</label>
        <input type="number" id="min-delay" value="2000" min="1000" max="10000">
        <br>
        <label for="max-delay">Max Rest Duration (ms):</label>
        <input type="number" id="max-delay" value="10000" min="2000" max="20000">
        <br>
        <div id="preset-buttons">
            <h3>Quick Presets</h3>
            <button onclick="setPreset(60, 2000, 5000)">1 min Test</button>
            <button onclick="setPreset(120, 2000, 10000)">2 min Test</button>
            <button onclick="setPreset(180, 2000, 10000)">3 min Test</button>
            <button onclick="setPreset(240, 2000, 10000)">4 min Test</button>
            <button onclick="setPreset(300, 2000, 10000)">5 min Test</button>
        </div>
        <button id="start-btn">Start PVT</button>
        <button id="start-panas-btn">Start PANAS</button>
        <button id="start-combined-btn">Start Combined (PANAS + PVT)</button>
    </div>

    <div id="task-screen">
        <p id="stimulus">Get Ready...</p>
    </div>

    <div id="panas-screen">
        <p id="panas-header">Indicate how you feel right now / Укажите, как вы чувствуете себя прямо сейчас</p>
        <div id="panas-word">
            <span id="panas-word-en"></span>
            <span id="panas-word-ru"></span>
        </div>
        <div id="panas-options" class="panas-options-container"></div>
    </div>

    <div id="end-screen">
        <h1>Task Complete</h1>
        <p id="results"></p>
        <pre id="full-reaction-times"></pre>
        <button id="restart-btn">Restart</button>
    </div>

    <script>
        let reactionTimes = [];
        let delays = [];
        let clickTimes = [];
        let testDuration = 60;
        let minDelay = 2000;
        let maxDelay = 10000;
        let startTime, stimulusTimeout, taskEndTimeout;
        let taskStartTime;
        let _EVENTS = [];
        let CLICK_NOW = false;
        let panasResponses = []; // Changed to array
        let panasStartTime;
        let isCombinedTest = false;
        let currentPanasIndex = 0;
        let currentPanasItem = null;

        const startScreen = document.getElementById('start-screen');
        const taskScreen = document.getElementById('task-screen');
        const panasScreen = document.getElementById('panas-screen');
        const endScreen = document.getElementById('end-screen');

        const testDurationInput = document.getElementById('test-duration');
        const minDelayInput = document.getElementById('min-delay');
        const maxDelayInput = document.getElementById('max-delay');
        const startBtn = document.getElementById('start-btn');
        const startPanasBtn = document.getElementById('start-panas-btn');
        const startCombinedBtn = document.getElementById('start-combined-btn');
        const restartBtn = document.getElementById('restart-btn');
        const stimulus = document.getElementById('stimulus');
        const results = document.getElementById('results');
        const fullReactionTimes = document.getElementById('full-reaction-times');
        const panasWordEn = document.getElementById('panas-word-en');
        const panasWordRu = document.getElementById('panas-word-ru');
        const panasOptionsDiv = document.getElementById('panas-options');

        const PANAS_ITEMS = [
            { en: "Interested", ru: "Увлеченный" },
            { en: "Distressed", ru: "Подавленный" },
            { en: "Excited", ru: "Радостный" },
            { en: "Upset", ru: "Расстроенный" },
            { en: "Strong", ru: "Полный сил" },
            { en: "Guilty", ru: "Виноватый" },
            { en: "Scared", ru: "Испуганный" },
            { en: "Hostile", ru: "Злой" },
            { en: "Enthusiastic", ru: "Заинтересованный" },
            { en: "Proud", ru: "Уверенный" },
            { en: "Irritable", ru: "Раздраженный" },
            { en: "Alert", ru: "Сосредоточенный" },
            { en: "Ashamed", ru: "Стыдящийся" },
            { en: "Inspired", ru: "Вдохновленный" },
            { en: "Nervous", ru: "Нервный" },
            { en: "Determined", ru: "Решительный" },
            { en: "Attentive", ru: "Внимательный" },
            { en: "Jittery", ru: "Беспокойный" },
            { en: "Active", ru: "Бодрый" },
            { en: "Afraid", ru: "Тревожный" }
        ];

        const PANAS_OPTIONS = [
            { value: 1, en: "Very slightly or not at all", ru: "Почти или совсем нет" },
            { value: 2, en: "A little", ru: "Немного" },
            { value: 3, en: "Moderately", ru: "Умеренно" },
            { value: 4, en: "Quite a bit", ru: "Значительно" },
            { value: 5, en: "Extremely", ru: "Очень сильно" }
        ];

        // Initialize PANAS options buttons once
        panasOptionsDiv.innerHTML = PANAS_OPTIONS.map(option => `
            <button class="panas-option-btn" 
                    onclick="recordPanasResponse('${option.value}')">
                <span class="panas-option-en">${option.en}</span>
                <span class="panas-option-ru">${option.ru}</span>
            </button>
        `).join('');

        startBtn.addEventListener('click', startTask);
        startPanasBtn.addEventListener('click', startPanas);
        startCombinedBtn.addEventListener('click', () => {
            isCombinedTest = true;
            startPanas();
        });
        restartBtn.addEventListener('click', resetTask);
        taskScreen.addEventListener('mousedown', onTaskScreenMouseDown);

        function log_event(event) {
            _EVENTS.push([event, (Date.now() - taskStartTime)]);
        }

        function onTaskScreenMouseDown() {
            var now = Date.now();
            clickTimes.push(now - taskStartTime);
            if (CLICK_NOW) {
                log_event('click');
                const reactionTime = now - startTime;
                reactionTimes.push(reactionTime);
                scheduleStimulus();
            } else {
                log_event('false_click');
            }
        }

        function setPreset(duration, minRest, maxRest) {
            testDurationInput.value = duration;
            minDelayInput.value = minRest;
            maxDelayInput.value = maxRest;
        }

        function startTask() {
            testDuration = parseInt(testDurationInput.value) || 60;
            minDelay = parseInt(minDelayInput.value) || 2000;
            maxDelay = parseInt(maxDelayInput.value) || 10000;

            reactionTimes = [];
            delays = [];
            clickTimes = [];
            _EVENTS = _EVENTS.length ? _EVENTS : [];

            startScreen.style.display = 'none';
            taskScreen.style.display = 'block';

            taskStartTime = taskStartTime || Date.now();
            log_event('pvt_start'); // Added PVT start event
            startTime = Date.now();
            scheduleStimulus();

            taskEndTimeout = setTimeout(endTask, testDuration * 1000);
        }

        function scheduleStimulus() {
            const delay = Math.random() * (maxDelay - minDelay) + minDelay;
            delays.push(Math.round(delay));

            stimulus.textContent = "Get Ready...";
            stimulus.style.color = '';
            CLICK_NOW = false;

            clearTimeout(stimulusTimeout);
            stimulusTimeout = setTimeout(() => {
                stimulus.textContent = "Click Now!";
                stimulus.style.color = 'red';
                CLICK_NOW = true;
                startTime = Date.now();
                log_event('stimulus');
            }, delay);
        }

        function startPanas() {
            startScreen.style.display = 'none';
            panasScreen.style.display = 'block';
            panasResponses = []; // Reset to empty array
            currentPanasIndex = 0;
            taskStartTime = Date.now();
            panasStartTime = Date.now();
            _EVENTS = [];
            showNextPanasItem();
        }

        function showNextPanasItem() {
            if (currentPanasIndex >= PANAS_ITEMS.length) {
                panasScreen.style.display = 'none';
                if (isCombinedTest) {
                    startTask();
                } else {
                    endTask();
                }
                return;
            }

            currentPanasItem = PANAS_ITEMS[currentPanasIndex];
            panasWordEn.textContent = currentPanasItem.en;
            panasWordRu.textContent = currentPanasItem.ru;
        }

        function recordPanasResponse(value) {
            if (!currentPanasItem) return;
            const timestamp = Date.now() - panasStartTime;
            panasResponses.push([currentPanasItem.en, parseInt(value), timestamp]); // New format
            _EVENTS.push(['panas_response_' + currentPanasItem.en, Date.now() - taskStartTime]);
            currentPanasIndex++;
            showNextPanasItem();
        }

        function mean(arr) {
            return arr.length ? (arr.reduce((a, b) => a + b, 0) / arr.length) : 0;
        }

        function customFormatter(obj) {
            function formatValue(value, indent = '') {
                if (Array.isArray(value)) {
                    const items = value.map(item => formatValue(item, indent)).join(', ');
                    return `[${items}]`;
                }
                if (typeof value === 'object' && value !== null) {
                    const nextIndent = indent + '  ';
                    const items = Object.entries(value).map(([key, val]) => 
                        `${nextIndent}"${key}": ${formatValue(val, nextIndent)}`
                    ).join(',\n');
                    return `{\n${items}\n${indent}}`;
                }
                if (typeof value === 'string') return `"${value}"`;
                return value;
            }
            return formatValue(obj);
        }

        function endTask() {
            clearTimeout(stimulusTimeout);
            clearTimeout(taskEndTimeout);

            taskScreen.style.display = 'none';
            endScreen.style.display = 'block';
            CLICK_NOW = false;

            let resultData = {
                test_datetime: (new Date).toLocaleString(),
                events: _EVENTS
            };

            if (reactionTimes.length > 0) { // PVT results
                const sortedTimes = [...reactionTimes].sort((a, b) => a - b);
                const filteredTimes = sortedTimes.slice(
                    Math.ceil(reactionTimes.length * 0.05),
                    Math.floor(reactionTimes.length * 0.95)
                );
                const averageTime = mean(filteredTimes).toFixed(2);

                results.textContent = `Average Reaction Time: ${averageTime} ms (${filteredTimes.length} trials, ${reactionTimes.length} trials minus top and bottom 5%)`;

                resultData = {
                    ...resultData,
                    test_type: isCombinedTest ? 'Combined PVT' : 'PVT',
                    averageReactionTime: `${averageTime} ms`,
                    testDuration: `${testDuration} seconds`,
                    minRestDuration: `${minDelay} ms`,
                    maxRestDuration: `${maxDelay} ms`,
                    totalTrials: reactionTimes.length,
                    filteredTrials: filteredTimes.length,
                    reactionTimes: reactionTimes
                };
            }

            if (panasResponses.length > 0) { // PANAS results
                const positiveScore = mean(PANAS_ITEMS.filter(item => 
                    ["Interested", "Excited", "Strong", "Enthusiastic", "Proud", 
                     "Alert", "Inspired", "Determined", "Attentive", "Active"]
                    .includes(item.en)).map(item => {
                        const response = panasResponses.find(r => r[0] === item.en);
                        return response ? response[1] : 0;
                    }));
                const negativeScore = mean(PANAS_ITEMS.filter(item => 
                    ["Distressed", "Upset", "Guilty", "Scared", "Hostile", 
                     "Irritable", "Ashamed", "Nervous", "Jittery", "Afraid"]
                    .includes(item.en)).map(item => {
                        const response = panasResponses.find(r => r[0] === item.en);
                        return response ? response[1] : 0;
                    }));

                if (reactionTimes.length === 0) { // standalone PANAS
                    results.textContent = `PANAS Results - Positive: ${positiveScore.toFixed(2)}, Negative: ${negativeScore.toFixed(2)}`;
                }

                resultData = {
                    ...resultData,
                    test_type: reactionTimes.length > 0 ? 'Combined PANAS + PVT' : 'PANAS',
                    panasResponses: panasResponses, // Already in new format
                    panasPositiveScore: positiveScore.toFixed(2),
                    panasNegativeScore: negativeScore.toFixed(2)
                };
            }

            const reactionTimesJSON = customFormatter(resultData);
            fullReactionTimes.textContent = `Full Results:\n${reactionTimesJSON}`;

            navigator.clipboard.writeText(reactionTimesJSON).then(() => {
                alert("Results JSON copied to clipboard!");
            }).catch(err => {
                console.error("Could not copy JSON to clipboard: ", err);
            });

            sendMessage(reactionTimesJSON, [resultData.test_type, 'json']);
            isCombinedTest = false;
        }

        function resetTask() {
            endScreen.style.display = 'none';
            startScreen.style.display = 'block';
        }
    </script>
</body>
</html>