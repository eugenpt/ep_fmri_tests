<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychomotor Vigilance Task (PVT)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100vh;
            background-color: #f4f4f9;
        }
        #task-screen, #end-screen {
            display: none;
        }
        #task-screen {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <h1>Psychomotor Vigilance Task (PVT)</h1>
        <label for="test-duration">Set Test Duration (seconds):</label>
        <input type="number" id="test-duration" value="60" min="10" max="600">
        <button id="start-btn">Start Task</button>
    </div>

    <div id="task-screen">
        <p id="stimulus">Get Ready...</p>
    </div>

    <div id="end-screen">
        <h1>Task Complete</h1>
        <p id="results"></p>
        <pre id="full-reaction-times"></pre>
        <button id="restart-btn">Restart</button>
    </div>

    <script>
        let reactionTimes = [];
        let testDuration = 60; // default in seconds
        let startTime, stimulusTimeout, taskEndTimeout;

        const startScreen = document.getElementById('start-screen');
        const taskScreen = document.getElementById('task-screen');
        const endScreen = document.getElementById('end-screen');

        const testDurationInput = document.getElementById('test-duration');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const stimulus = document.getElementById('stimulus');
        const results = document.getElementById('results');
        const fullReactionTimes = document.getElementById('full-reaction-times');

        startBtn.addEventListener('click', startTask);
        restartBtn.addEventListener('click', resetTask);

        function startTask() {
            testDuration = parseInt(testDurationInput.value) || 60;
            reactionTimes = [];

            startScreen.style.display = 'none';
            taskScreen.style.display = 'block';

            startTime = Date.now();
            scheduleStimulus();

            taskEndTimeout = setTimeout(endTask, testDuration * 1000);
        }

        function scheduleStimulus() {
            const delay = Math.random() * 8000 + 2000; // Random delay between 2-10 seconds

            stimulus.textContent = "Get Ready...";
            stimulus.style.color = '';

            taskScreen.onmousedown = () => {};

            clearTimeout(stimulusTimeout);

            stimulusTimeout = setTimeout(() => {
                stimulus.textContent = "Click Now!";
                stimulus.style.color = 'red';

                taskScreen.onmousedown = () => {
                    const reactionTime = Date.now() - startTime;
                    reactionTimes.push(reactionTime);
                    scheduleStimulus();
                };

                startTime = Date.now();
            }, delay);
        }

        function mean(arr) {
            return arr.length
                ? (arr.reduce((a, b) => a + b, 0) / arr.length)
                : 0;
        }

        function endTask() {
            clearTimeout(stimulusTimeout);
            clearTimeout(taskEndTimeout);

            taskScreen.style.display = 'none';
            endScreen.style.display = 'block';

            const sortedTimes = [...reactionTimes].sort((a, b) => a - b);
            const filteredTimes = sortedTimes.slice(
                Math.ceil(reactionTimes.length * 0.05),
                Math.floor(reactionTimes.length * 0.95)
            );

            const averageTime = mean(filteredTimes).toFixed(2);
            results.textContent = `Average Reaction Time: ${averageTime} ms (${filteredTimes.length} trials, ${reactionTimes.length} trials minus top and bottom 5%)`;

            // Display full reaction times
            const reactionTimesJSON = JSON.stringify(reactionTimes, null, 2);
            fullReactionTimes.textContent = `Full Reaction Times:\n${reactionTimesJSON}`;

            // Copy to clipboard
            navigator.clipboard.writeText(reactionTimesJSON).then(() => {
                alert("Reaction times JSON copied to clipboard!");
            }).catch(err => {
                console.error("Could not copy JSON to clipboard: ", err);
            });
        }

        function resetTask() {
            endScreen.style.display = 'none';
            startScreen.style.display = 'block';
        }
    </script>
</body>
</html>
